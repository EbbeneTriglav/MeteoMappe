<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Mappa Meteo - San Pellegrino Terme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Heatmap -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 60vh; width: 100%; }
    .controls {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px; border-top: 1px solid #eee;
    }
    .controls label { font-weight: bold; }
    .date-display { min-width: 160px; font-family: monospace; }
    table { border-collapse: collapse; margin: 20px auto; width: 95%; max-width: 1100px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
    th { background: #f7f7f7; }
    h2 { text-align: center; margin: 20px 0 8px; }
    .loading { text-align: center; padding: 10px; color: #666; }
    .legend { margin: 0 16px 12px 16px; font-size: 13px; color: #444; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <label for="daySlider">Giorno storico:</label>
    <input id="daySlider" type="range" min="0" max="0" value="0" step="1" />
    <span id="dayLabel" class="date-display">--</span>
    <span id="intensityLabel" class="legend">Heatmap basata su precipitation_sum (mm/giorno)</span>
  </div>

  <h2>Previsioni precipitazioni (5 giorni)</h2>
  <div id="forecastLoading" class="loading">Caricamento previsioni…</div>
  <table id="forecastTable" style="display:none;">
    <thead>
      <tr><th>Data</th><th>Probabilità (%)</th><th>Cumulata (mm)</th><th>Intensità max (mm/h)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Precipitazioni cadute (ultimi 5 giorni)</h2>
  <div id="historyLoading" class="loading">Caricamento storico…</div>
  <table id="historyTable" style="display:none;">
    <thead>
      <tr><th>Data</th><th>Cumulata (mm)</th><th>Intensità max (mm/h)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // --- Località (nome: [lat, lon]) ---
    const locations = {
      "Sussia": [45.833, 9.633],
      "Piazzacava": [45.850, 9.657],
      "Foldone": [45.8491, 9.6161],
      "Monte Molinasco": [45.854429482557435, 9.64178530454687],
      "San Pellegrino Terme": [45.848687593657786, 9.666033864451745],
      "Aplecchio": [45.842273445543654, 9.656271242169542],
      "Vettarola": [45.846151165569296, 9.630560511873826],
      "Catremerio": [45.822366845838566, 9.633348279863643]
    };

    // --- Mappa ---
    const map = L.map('map').setView([45.8487, 9.6660], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Marker stazioni (popup aggiornabile)
    const stationMarkers = {};
    for (let name in locations) {
      const [lat, lon] = locations[name];
      stationMarkers[name] = L.marker([lat, lon]).addTo(map).bindPopup(`${name}<br/>Cumulata: -- mm`);
    }

    // --- Utility date ---
    function toISODate(d) { return d.toISOString().split('T')[0]; }
    function fmt(val, digits=1) { return (val ?? 0).toFixed(digits); }

    // --- Finestre temporali ---
    const today = new Date();
    const startHist = new Date(today); startHist.setDate(today.getDate() - 5);
    const endHist = new Date(today); endHist.setDate(today.getDate() - 1);

    // --- Fetch Open-Meteo per una località ---
    async function fetchForLocation(lat, lon) {
      const forecastUrl =
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&daily=precipitation_sum,precipitation_probability_max,precipitation_hours` +
        `&hourly=precipitation` +
        `&timezone=Europe/Rome&forecast_days=5`;

      const historyUrl =
        `https://historical-forecast-api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&start_date=${toISODate(startHist)}&end_date=${toISODate(endHist)}` +
        `&daily=precipitation_sum,precipitation_hours` +
        `&hourly=precipitation` +
        `&timezone=Europe/Rome`;

      const [fResp, hResp] = await Promise.all([fetch(forecastUrl), fetch(historyUrl)]);
      if (!fResp.ok) throw new Error(`Forecast 400: ${await fResp.text()}`);
      if (!hResp.ok) throw new Error(`History 400: ${await hResp.text()}`);
      const forecast = await fResp.json();
      const history = await hResp.json();
      return { forecast, history };
    }

    // --- Aggregazione oraria -> giornaliera (max intensità mm/h) ---
    function dailyMaxFromHourly(hourly) {
      // hourly.precipitation: array in mm, hourly.time: array di ISO string
      if (!hourly || !hourly.time || !hourly.precipitation) return {};
      const maxByDate = {};
      for (let i = 0; i < hourly.time.length; i++) {
        const date = hourly.time[i].split('T')[0];
        const val = Number(hourly.precipitation[i] ?? 0);
        maxByDate[date] = Math.max(maxByDate[date] ?? 0, val);
      }
      return maxByDate;
    }

    // --- Carica e aggrega tutte le località ---
    async function loadAll() {
      const forecastAgg = {};         // date: {prob,sum,max,count}
      const historyAgg = {};          // date: {sum,max,count}
      const historyByDay = {};        // date: [[lat,lon,value], ...]
      const historyPerStation = {};   // date: { stationName: {sum,max} }

      for (let name in locations) {
        const [lat, lon] = locations[name];

        let data;
        try { data = await fetchForLocation(lat, lon); }
        catch (e) { console.warn("Errore fetch", name, e); continue; }

        // Forecast aggregazione
        const f = data.forecast;
        const fDaily = f?.daily;
        const fHourly = f?.hourly;
        const fMaxByDate = dailyMaxFromHourly(fHourly);

        if (fDaily && fDaily.time) {
          fDaily.time.forEach((d, i) => {
            const prob = Number(fDaily.precipitation_probability_max?.[i] ?? 0);
            const sum  = Number(fDaily.precipitation_sum?.[i] ?? 0);
            const max  = Number(fMaxByDate[d] ?? 0);

            if (!forecastAgg[d]) forecastAgg[d] = { prob:0, sum:0, max:0, count:0 };
            forecastAgg[d].prob += prob;
            forecastAgg[d].sum  += sum;
            forecastAgg[d].max  += max;
            forecastAgg[d].count++;
          });
        }

        // Storico aggregazione
        const h = data.history;
        const hDaily = h?.daily;
        const hHourly = h?.hourly;
        const hMaxByDate = dailyMaxFromHourly(hHourly);

        if (hDaily && hDaily.time) {
          hDaily.time.forEach((d, i) => {
            const sum = Number(hDaily.precipitation_sum?.[i] ?? 0);
            const max = Number(hMaxByDate[d] ?? 0);

            if (!historyAgg[d]) historyAgg[d] = { sum:0, max:0, count:0 };
            historyAgg[d].sum += sum;
            historyAgg[d].max += max;
            historyAgg[d].count++;

            if (!historyByDay[d]) historyByDay[d] = [];
            historyByDay[d].push([lat, lon, sum]);

            if (!historyPerStation[d]) historyPerStation[d] = {};
            historyPerStation[d][name] = { sum, max };
          });
        }
      }

      // --- Tabella Forecast (medie su località) ---
      const fTbody = document.querySelector("#forecastTable tbody");
      const fLoading = document.getElementById("forecastLoading");
      const fTable = document.getElementById("forecastTable");
      const forecastDates = Object.keys(forecastAgg).sort();

      forecastDates.forEach(d => {
        const row = forecastAgg[d];
        const probAvg = row.count ? (row.prob / row.count) : 0;
        const sumAvg  = row.count ? (row.sum / row.count) : 0;
        const maxAvg  = row.count ? (row.max / row.count) : 0;
        fTbody.insertAdjacentHTML("beforeend",
          `<tr><td>${d}</td><td>${fmt(probAvg,0)}</td><td>${fmt(sumAvg,1)}</td><td>${fmt(maxAvg,1)}</td></tr>`);
      });
      fLoading.style.display = "none";
      fTable.style.display = "";

      // --- Tabella Storico (medie su località) ---
      const hTbody = document.querySelector("#historyTable tbody");
      const hLoading = document.getElementById("historyLoading");
      const hTable = document.getElementById("historyTable");
      const historyDates = Object.keys(historyAgg).sort();

      historyDates.forEach(d => {
        const row = historyAgg[d];
        const sumAvg = row.count ? (row.sum / row.count) : 0;
        const maxAvg = row.count ? (row.max / row.count) : 0;
        hTbody.insertAdjacentHTML("beforeend",
          `<tr><td>${d}</td><td>${fmt(sumAvg,1)}</td><td>${fmt(maxAvg,1)}</td></tr>`);
      });
      hLoading.style.display = "none";
      hTable.style.display = "";

      // --- Slider temporale per heatmap ---
      const daySlider = document.getElementById("daySlider");
      const dayLabel = document.getElementById("dayLabel");
      daySlider.min = 0;
      daySlider.max = Math.max(0, historyDates.length - 1);
      daySlider.value = daySlider.max;

      let heatLayer = null;
      function updateHeatmap(idx) {
        const date = historyDates[idx];
        dayLabel.textContent = date ?? "--";
        const points = historyByDay[date] ?? [];

        if (heatLayer) map.removeLayer(heatLayer);
        heatLayer = L.heatLayer(points, { radius: 45, blur: 28, maxZoom: 13 });
        heatLayer.addTo(map);

        // Aggiorna popup dei marker con cumulata del giorno selezionato
        const perStation = historyPerStation[date] ?? {};
        for (let name in stationMarkers) {
          const val = perStation[name]?.sum ?? null;
          const txt = (val === null) ? "--" : fmt(val, 1);
          stationMarkers[name].setPopupContent(`${name}<br/>Cumulata: ${txt} mm`);
        }
      }

      daySlider.addEventListener("input", () => updateHeatmap(Number(daySlider.value)));

      // Inizializza sul giorno più recente
      updateHeatmap(Number(daySlider.value));

      // --- (Opzionale) Animazione automatica ---
      // let idx = Number(daySlider.value);
      // setInterval(() => {
      //   idx = (idx + 1) % historyDates.length;
      //   daySlider.value = idx;
      //   updateHeatmap(idx);
      // }, 2000);
    }

    // Avvio
    loadAll().catch(e => {
      console.error("Errore generale caricamento dati:", e);
      document.getElementById("forecastLoading").textContent = "Errore nel caricamento previsioni.";
      document.getElementById("historyLoading").textContent = "Errore nel caricamento storico.";
    });
  </script>
</body>
</html>


