<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Mappa Meteo e Analisi - San Pellegrino Terme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Heatmap -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; line-height: 1.3; }
    h2 { text-align: center; margin: 18px 0 8px; }
    h3 { margin: 16px 0 6px; }
    #mapHistoric, #mapForecast { height: 55vh; width: 100%; }
    .controls {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px; border-top: 1px solid #eee; border-bottom: 1px solid #eee;
      flex-wrap: wrap;
    }
    .controls label { font-weight: bold; }
    .date-display { min-width: 160px; font-family: monospace; }
    .legend {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; color: #444;
    }
    .legend-bar {
      width: 160px; height: 10px; background: linear-gradient(to right, #0b0f49, #2155b5, #3cc1ff, #7fff7f, #ffd93d, #ff7f27, #c40000);
      border: 1px solid #999;
    }
    .legend-labels {
      display: flex; justify-content: space-between; width: 160px; font-size: 11px; color: #333;
    }
    .section { padding-bottom: 18px; }
    table { border-collapse: collapse; margin: 12px auto; width: 95%; max-width: 1200px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
    th { background: #f7f7f7; }
    .loading { text-align: center; padding: 10px; color: #666; }
    .totals { text-align: center; margin: 6px 0 12px; font-weight: bold; }
    .grid-two { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 12px; }
    .note { font-size: 12px; color: #555; text-align: center; margin: 8px 0; }
    .label-icon { background: rgba(0,0,0,0.7); color: #fff; padding: 2px 4px; border-radius: 3px; font-size: 11px; }
  </style>
</head>
<body>

  <div class="section">
    <h2>Heatmap storica (ultimi 10 giorni)</h2>
    <div id="mapHistoric"></div>
    <div class="controls">
      <label for="histSlider">Giorno storico:</label>
      <input id="histSlider" type="range" min="0" max="0" value="0" step="1" />
      <span id="histLabel" class="date-display">--</span>
      <div class="legend">
        <div class="legend-bar"></div>
        <div>
          <div>Intensità heatmap: precipitation_sum (mm/giorno)</div>
          <div class="legend-labels"><span>0</span><span>10</span><span>25</span><span>50+</span></div>
        </div>
      </div>
    </div>
    <div id="histTotals" class="totals">Totale cumulata ultimi 10 giorni: -- mm (media su stazioni)</div>

    <h3>Precipitazioni cadute (ultimi 10 giorni - media su stazioni)</h3>
    <div id="historyLoading" class="loading">Caricamento storico…</div>
    <table id="historyTable" style="display:none;">
      <thead>
        <tr><th>Data</th><th>Cumulata (mm)</th><th>Intensità max (mm/h)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Heatmap forecast (prossimi giorni)</h2>
    <div id="mapForecast"></div>
    <div class="controls">
      <label for="fcSlider">Giorno forecast:</label>
      <input id="fcSlider" type="range" min="0" max="0" value="0" step="1" />
      <span id="fcLabel" class="date-display">--</span>
      <div class="legend">
        <div class="legend-bar"></div>
        <div>
          <div>Intensità heatmap: precipitation_sum (mm/giorno)</div>
          <div class="legend-labels"><span>0</span><span>10</span><span>25</span><span>50+</span></div>
        </div>
      </div>
    </div>

    <h3>Previsioni precipitazioni (media su stazioni)</h3>
    <div id="forecastLoading" class="loading">Caricamento previsioni…</div>
    <table id="forecastTable" style="display:none;">
      <thead>
        <tr><th>Data</th><th>Probabilità (%)</th><th>Cumulata (mm)</th><th>Intensità max (mm/h)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Tabelle annuali per stazione (2022–2025)</h2>
    <div class="note">Le tabelle mostrano: cumulata totale annua, massimi su finestre 1h, 3h, 6h, 12h, 24h, 48h, 72h, numero di giorni con precipitazioni.</div>
    <div id="annualLoading" class="loading">Caricamento dati annuali…</div>
    <div id="annualTables"></div>
  </div>

  <script>
    // --- Località (nome: [lat, lon]) ---
    const locations = {
      "Sussia": [45.833, 9.633],
      "Piazzacava": [45.850, 9.657],
      "Foldone": [45.8491, 9.6161],
      "Monte Molinasco": [45.854429482557435, 9.64178530454687],
      "San Pellegrino Terme": [45.848687593657786, 9.666033864451745],
      "Aplecchio": [45.842273445543654, 9.656271242169542],
      "Vettarola": [45.846151165569296, 9.630560511873826],
      "Catremerio": [45.822366845838566, 9.633348279863643]
    };

    // --- Utility ---
    const fmt = (v, d=1) => (Number(v ?? 0)).toFixed(d);
    const isoDate = d => d.toISOString().split('T')[0];
    const today = new Date();
    // Storico 10 giorni: da (oggi-10) a (ieri)
    const startHist = new Date(today); startHist.setDate(today.getDate() - 10);
    const endHist   = new Date(today); endHist.setDate(today.getDate() - 1);

    // --- Mappe ---
    const mapHistoric = L.map('mapHistoric').setView([45.8487, 9.6660], 13);
    const mapForecast = L.map('mapForecast').setView([45.8487, 9.6660], 13);

    const osmOpts = { maxZoom: 18, attribution: '© OpenStreetMap' };
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', osmOpts).addTo(mapHistoric);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', osmOpts).addTo(mapForecast);

    // Marker e label per stazioni (storico e forecast)
    const stationMarkersHist = {};
    const stationMarkersFc = {};
    const stationLabelsHist = {};
    const stationLabelsFc = {};

    function makeLabelIcon(text) {
      return L.divIcon({ className: 'label-icon', html: text, iconSize: [30, 14], iconAnchor: [15, -4] });
    }

    for (let name in locations) {
      const [lat, lon] = locations[name];
      // Storico
      stationMarkersHist[name] = L.marker([lat, lon]).addTo(mapHistoric).bindPopup(`${name}<br/>Cumulata: -- mm`);
      stationLabelsHist[name] = L.marker([lat, lon], { icon: makeLabelIcon('') }).addTo(mapHistoric);
      // Forecast
      stationMarkersFc[name] = L.marker([lat, lon]).addTo(mapForecast).bindPopup(`${name}<br/>Cumulata: -- mm`);
      stationLabelsFc[name] = L.marker([lat, lon], { icon: makeLabelIcon('') }).addTo(mapForecast);
    }

    // --- Fetch Open-Meteo ---
    async function fetchHistoric(lat, lon) {
      const url =
        `https://historical-forecast-api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&start_date=${isoDate(startHist)}&end_date=${isoDate(endHist)}` +
        `&daily=precipitation_sum` +
        `&hourly=precipitation` +
        `&timezone=Europe/Rome`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Historic error: ${await resp.text()}`);
      return resp.json();
    }

    async function fetchForecast(lat, lon, days=7) {
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&daily=precipitation_sum,precipitation_probability_max` +
        `&hourly=precipitation` +
        `&timezone=Europe/Rome&forecast_days=${Math.min(days,7)}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Forecast error: ${await resp.text()}`);
      return resp.json();
    }

    // Daily max intensity from hourly
    function dailyMaxFromHourly(hourly) {
      const out = {};
      if (!hourly || !hourly.time || !hourly.precipitation) return out;
      for (let i=0;i<hourly.time.length;i++) {
        const d = hourly.time[i].split('T')[0];
        const v = Number(hourly.precipitation[i] ?? 0);
        out[d] = Math.max(out[d] ?? 0, v);
      }
      return out;
    }

    // --- Caricamento base: storico 10 giorni + forecast ---
    async function loadBase() {
      const histAgg = {};      // d: {sum, count}
      const histMax = {};      // d: {maxSum, count} (max da hourly)
      const histByDay = {};    // d: [[lat,lon,sum], ...]
      const histPerStation = {}; // d: {name: sum}

      const fcAgg = {};        // d: {prob, sum, count}
      const fcMax = {};        // d: {max, count}
      const fcByDay = {};      // d: [[lat,lon,sum], ...]
      const fcPerStation = {}; // d: {name: sum}

      for (let name in locations) {
        const [lat, lon] = locations[name];
        const [hist, fc] = await Promise.all([fetchHistoric(lat, lon), fetchForecast(lat, lon, 7)]);

        // Storico
        const hDaily = hist?.daily;
        const hHourly = hist?.hourly;
        const hMaxByDate = dailyMaxFromHourly(hHourly);
        if (hDaily?.time) {
          hDaily.time.forEach((d, i) => {
            const sum = Number(hDaily.precipitation_sum?.[i] ?? 0);
            histAgg[d] = histAgg[d] || {sum:0, count:0};
            histAgg[d].sum += sum; histAgg[d].count++;

            histMax[d] = histMax[d] || {max:0, count:0};
            histMax[d].max += Number(hMaxByDate[d] ?? 0); histMax[d].count++;

            histByDay[d] = histByDay[d] || [];
            histByDay[d].push([lat, lon, sum]);

            histPerStation[d] = histPerStation[d] || {};
            histPerStation[d][name] = sum;
          });
        }

        // Forecast
        const fDaily = fc?.daily;
        const fHourly = fc?.hourly;
        const fMaxByDate = dailyMaxFromHourly(fHourly);
        if (fDaily?.time) {
          fDaily.time.forEach((d, i) => {
            const prob = Number(fDaily.precipitation_probability_max?.[i] ?? 0);
            const sum  = Number(fDaily.precipitation_sum?.[i] ?? 0);
            fcAgg[d] = fcAgg[d] || {prob:0, sum:0, count:0};
            fcAgg[d].prob += prob; fcAgg[d].sum += sum; fcAgg[d].count++;

            fcMax[d] = fcMax[d] || {max:0, count:0};
            fcMax[d].max += Number(fMaxByDate[d] ?? 0); fcMax[d].count++;

            fcByDay[d] = fcByDay[d] || [];
            fcByDay[d].push([lat, lon, sum]);

            fcPerStation[d] = fcPerStation[d] || {};
            fcPerStation[d][name] = sum;
          });
        }
      }

      // Tabelle storico 10 giorni
      const histDates = Object.keys(histAgg).sort();
      const hTbody = document.querySelector("#historyTable tbody");
      let total10 = 0;
      histDates.forEach(d => {
        const avgSum = histAgg[d].sum / histAgg[d].count;
        const avgMax = histMax[d].max / histMax[d].count;
        total10 += avgSum;
        hTbody.insertAdjacentHTML("beforeend",
          `<tr><td>${d}</td><td>${fmt(avgSum,1)}</td><td>${fmt(avgMax,1)}</td></tr>`);
      });
      document.getElementById("historyLoading").style.display = "none";
      document.getElementById("historyTable").style.display = "";
      document.getElementById("histTotals").textContent =
        `Totale cumulata ultimi 10 giorni: ${fmt(total10,1)} mm (media su stazioni)`;

      // Slider storico + heatmap
      const histSlider = document.getElementById("histSlider");
      const histLabel = document.getElementById("histLabel");
      histSlider.min = 0; histSlider.max = Math.max(0, histDates.length-1); histSlider.value = histSlider.max;
      let heatHist = null;

      function gradientIntensity(points) {
        // intensifica il peso: clamp 0..60
        return points.map(p => [p[0], p[1], Math.min(60, Math.max(0, p[2]))]);
      }

      function updateHist(idx) {
        const date = histDates[idx];
        histLabel.textContent = date ?? "--";
        const points = gradientIntensity(histByDay[date] || []);
        if (heatHist) mapHistoric.removeLayer(heatHist);
        heatHist = L.heatLayer(points, {
          radius: 50, blur: 30, maxZoom: 13,
          gradient: {0.0:'#0b0f49',0.2:'#2155b5',0.4:'#3cc1ff',0.6:'#7fff7f',0.8:'#ffd93d',1.0:'#c40000'}
        }).addTo(mapHistoric);

        // Etichette dinamiche + popup
        const perStation = histPerStation[date] || {};
        for (let name in stationMarkersHist) {
          const v = perStation[name] ?? null;
          const txt = (v===null) ? '' : `${fmt(v,1)} mm`;
          stationMarkersHist[name].setPopupContent(`${name}<br/>Cumulata: ${txt || '--'}${txt ? '' : ''}`);
          stationLabelsHist[name].setIcon(makeLabelIcon(v && v>0 ? txt : ''));
        }
      }
      histSlider.addEventListener("input", () => updateHist(Number(histSlider.value)));
      updateHist(Number(histSlider.value));

      // Tabelle forecast
      const fcDates = Object.keys(fcAgg).sort();
      const fTbody = document.querySelector("#forecastTable tbody");
      fcDates.forEach(d => {
        const avgProb = fcAgg[d].prob / fcAgg[d].count;
        const avgSum  = fcAgg[d].sum  / fcAgg[d].count;
        const avgMax  = fcMax[d].max  / fcMax[d].count;
        fTbody.insertAdjacentHTML("beforeend",
          `<tr><td>${d}</td><td>${fmt(avgProb,0)}</td><td>${fmt(avgSum,1)}</td><td>${fmt(avgMax,1)}</td></tr>`);
      });
      document.getElementById("forecastLoading").style.display = "none";
      document.getElementById("forecastTable").style.display = "";

      // Slider forecast + heatmap
      const fcSlider = document.getElementById("fcSlider");
      const fcLabel = document.getElementById("fcLabel");
      fcSlider.min = 0; fcSlider.max = Math.max(0, fcDates.length-1); fcSlider.value = fcSlider.max;
      let heatFc = null;

      function updateFc(idx) {
        const date = fcDates[idx];
        fcLabel.textContent = date ?? "--";
        const points = gradientIntensity(fcByDay[date] || []);
        if (heatFc) mapForecast.removeLayer(heatFc);
        heatFc = L.heatLayer(points, {
          radius: 50, blur: 30, maxZoom: 13,
          gradient: {0.0:'#0b0f49',0.2:'#2155b5',0.4:'#3cc1ff',0.6:'#7fff7f',0.8:'#ffd93d',1.0:'#c40000'}
        }).addTo(mapForecast);

        // Etichette dinamiche + popup
        const perStation = fcPerStation[date] || {};
        for (let name in stationMarkersFc) {
          const v = perStation[name] ?? null;
          const txt = (v===null) ? '' : `${fmt(v,1)} mm`;
          stationMarkersFc[name].setPopupContent(`${name}<br/>Prevista: ${txt || '--'}`);
          stationLabelsFc[name].setIcon(makeLabelIcon(v && v>0 ? txt : ''));
        }
      }
      fcSlider.addEventListener("input", () => updateFc(Number(fcSlider.value)));
      updateFc(Number(fcSlider.value));
    }

    // --- Tabelle annuali per stazione ---
    async function fetchYear(lat, lon, year) {
      const start = `${year}-01-01`, end = `${year}-12-31`;
      const url =
        `https://historical-forecast-api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&start_date=${start}&end_date=${end}` +
        `&daily=precipitation_sum` +
        `&hourly=precipitation` +
        `&timezone=Europe/Rome`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Annual ${year} error: ${await resp.text()}`);
      return resp.json();
    }

    function rollingMaxSum(hourlyTimes, hourlyVals, hoursWindow) {
      // Somma mobile su finestra in ore; assume passo orario
      if (!hourlyTimes || !hourlyVals || hourlyTimes.length !== hourlyVals.length) return 0;
      const n = hourlyVals.length;
      const w = hoursWindow;
      let maxSum = 0, curr = 0, q = [];
      for (let i=0; i<n; i++) {
        const v = Number(hourlyVals[i] ?? 0);
        q.push(v); curr += v;
        if (q.length > w) curr -= q.shift();
        if (q.length === w) maxSum = Math.max(maxSum, curr);
      }
      return maxSum;
    }

    function countWetDays(dailyTimes, dailySumVals, threshold=0.1) {
      if (!dailyTimes || !dailySumVals) return 0;
      let c=0;
      for (let i=0;i<dailyTimes.length;i++) {
        const v = Number(dailySumVals[i] ?? 0);
        if (v >= threshold) c++;
      }
      return c;
    }

    async function loadAnnual() {
      const years = [2022, 2023, 2024, 2025];
      const container = document.getElementById("annualTables");

      for (let name in locations) {
        const [lat, lon] = locations[name];

        // Costruisci tabella
        let html = `<h3>${name}</h3><table><thead>
          <tr><th>Anno</th><th>Cumulata totale (mm)</th>
          <th>Max 1h</th><th>Max 3h</th><th>Max 6h</th><th>Max 12h</th><th>Max 24h</th><th>Max 48h</th><th>Max 72h</th>
          <th>Giorni piovosi</th></tr></thead><tbody>`;

        for (const y of years) {
          let data;
          try { data = await fetchYear(lat, lon, y); }
          catch (e) { console.warn("Annual fetch error", name, y, e); continue; }

          const dTimes = data?.daily?.time;
          const dSum   = data?.daily?.precipitation_sum;
          const hTimes = data?.hourly?.time;
          const hVals  = data?.hourly?.precipitation;

          const total = (dSum || []).reduce((a,b)=>a+Number(b||0),0);
          const max1  = rollingMaxSum(hTimes, hVals, 1);
          const max3  = rollingMaxSum(hTimes, hVals, 3);
          const max6  = rollingMaxSum(hTimes, hVals, 6);
          const max12 = rollingMaxSum(hTimes, hVals, 12);
          const max24 = rollingMaxSum(hTimes, hVals, 24);
          const max48 = rollingMaxSum(hTimes, hVals, 48);
          const max72 = rollingMaxSum(hTimes, hVals, 72);
          const wet   = countWetDays(dTimes, dSum, 0.1);

          html += `<tr><td>${y}</td><td>${fmt(total,1)}</td>
            <td>${fmt(max1,1)}</td><td>${fmt(max3,1)}</td><td>${fmt(max6,1)}</td>
            <td>${fmt(max12,1)}</td><td>${fmt(max24,1)}</td><td>${fmt(max48,1)}</td><td>${fmt(max72,1)}</td>
            <td>${wet}</td></tr>`;
        }

        html += `</tbody></table>`;
        container.insertAdjacentHTML("beforeend", html);
      }

      document.getElementById("annualLoading").style.display = "none";
    }

    // Avvii
    (async () => {
      try {
        await loadBase();
        await loadAnnual();
      } catch (e) {
        console.error("Errore generale:", e);
        document.getElementById("historyLoading").textContent = "Errore caricamento storico.";
        document.getElementById("forecastLoading").textContent = "Errore caricamento previsioni.";
        document.getElementById("annualLoading").textContent = "Errore caricamento dati annuali.";
      }
    })();
  </script>
</body>
</html>

